<!-- src/views/dashboard.ejs - Dashboard view corrigida -->
<%- include('partials/header', {
  titulo: 'Dashboard',
  subtitulo: 'Visão geral do seu negócio',
  user: locals.user,
  currentPage: 'dashboard'
}) %>

<div class="dashboard-container">
  <!-- KPIs Principais -->
  <div class="kpi-grid">
    <div class="kpi-card positive">
      <div class="kpi-icon">💰</div>
      <div class="kpi-content">
        <h3>Faturamento do Mês</h3>
        <div class="kpi-value">
          R$ <%= dashboardData.faturamentoMes.toLocaleString('pt-BR', {minimumFractionDigits: 2}) %>
        </div>
        <div class="kpi-change <%= dashboardData.crescimentoFaturamento >= 0 ? 'positive' : 'negative' %>">
          <%= dashboardData.crescimentoFaturamento >= 0 ? '↗' : '↘' %> <%= Math.abs(dashboardData.crescimentoFaturamento) %>%
          <span class="kpi-previous">Mês passado: R$ <%= dashboardData.faturamentoMesPassado.toLocaleString('pt-BR', {minimumFractionDigits: 2}) %></span>
        </div>
      </div>
    </div>

    <div class="kpi-card">
      <div class="kpi-icon">📈</div>
      <div class="kpi-content">
        <h3>Lucro do Mês</h3>
        <div class="kpi-value <%= dashboardData.lucroMes >= 0 ? 'positive' : 'negative' %>">
          R$ <%= dashboardData.lucroMes.toLocaleString('pt-BR', {minimumFractionDigits: 2}) %>
        </div>
        <div class="kpi-subtitle">
          Margem: <%= dashboardData.margemLucro %>%
        </div>
      </div>
    </div>

    <div class="kpi-card">
      <div class="kpi-icon">🏦</div>
      <div class="kpi-content">
        <h3>Fluxo de Caixa</h3>
        <div class="kpi-value <%= dashboardData.fluxoCaixa.saldo >= 0 ? 'positive' : 'negative' %>">
          R$ <%= dashboardData.fluxoCaixa.saldo.toLocaleString('pt-BR', {minimumFractionDigits: 2}) %>
        </div>
        <div class="kpi-subtitle">
          ↗ <%= dashboardData.fluxoCaixa.entradas.toLocaleString('pt-BR', {minimumFractionDigits: 2}) %> | 
          ↘ <%= dashboardData.fluxoCaixa.saidas.toLocaleString('pt-BR', {minimumFractionDigits: 2}) %>
        </div>
      </div>
    </div>

    <div class="kpi-card <%= dashboardData.contasVencidas.total > 0 ? 'warning' : '' %>">
      <div class="kpi-icon">⚠️</div>
      <div class="kpi-content">
        <h3>Contas Vencidas</h3>
        <div class="kpi-value">
          R$ <%= dashboardData.contasVencidas.total.toLocaleString('pt-BR', {minimumFractionDigits: 2}) %>
        </div>
        <div class="kpi-subtitle">
          <%= dashboardData.contasVencidas.quantidade %> parcelas em atraso
        </div>
      </div>
    </div>
  </div>

  <!-- Widgets Secundários -->
  <div class="widgets-grid">
    <!-- Produtos Baixo Estoque -->
    <div class="widget-card">
      <h3>🚨 Estoque Baixo</h3>
      <% if (dashboardData.produtosBaixoEstoque.length > 0) { %>
        <% dashboardData.produtosBaixoEstoque.forEach(produto => { %>
          <div class="alert-item">
            <strong><%= produto.codigo %></strong> - <%= produto.descricao %>
            <small>Saldo: <%= produto.saldo_atual %> | Mín: <%= produto.estoque_minimo %></small>
          </div>
        <% }) %>
      <% } else { %>
        <p class="text-success">✅ Todos os produtos com estoque adequado</p>
      <% } %>
    </div>

    <!-- Top Produtos -->
    <div class="widget-card">
      <h3>🏆 Top Vendas do Mês</h3>
      <% if (dashboardData.topProdutos.length > 0) { %>
        <% dashboardData.topProdutos.forEach((produto, index) => { %>
          <div class="ranking-item">
            <span class="rank">#<%= index + 1 %></span>
            <div>
              <strong><%= produto.codigo %></strong> - <%= produto.descricao %>
              <small><%= produto.total_vendido %> un | R$ <%= parseFloat(produto.faturamento_produto).toLocaleString('pt-BR', {minimumFractionDigits: 2}) %></small>
            </div>
          </div>
        <% }) %>
      <% } else { %>
        <p>Nenhuma venda registrada no mês</p>
      <% } %>
    </div>

    <!-- Entregas -->
    <div class="widget-card">
      <h3>🚚 Entregas do Mês</h3>
      <div class="stats-row">
        <div class="stat">
          <span class="stat-number"><%= dashboardData.entregas.total %></span>
          <span class="stat-label">Total</span>
        </div>
        <div class="stat">
          <span class="stat-number warning"><%= dashboardData.entregas.pendentes %></span>
          <span class="stat-label">Pendentes</span>
        </div>
        <div class="stat">
          <span class="stat-number positive"><%= dashboardData.entregas.entregues %></span>
          <span class="stat-label">Entregues</span>
        </div>
      </div>
    </div>

    <!-- Inadimplência -->
    <div class="widget-card">
      <h3>📊 Inadimplência</h3>
      <div class="stats-col">
        <div class="stat-item">
          <span class="stat-value"><%= dashboardData.inadimplencia.clientes_inadimplentes %></span>
          <span class="stat-desc">Clientes em atraso</span>
        </div>
        <div class="stat-item">
          <span class="stat-value warning">R$ <%= parseFloat(dashboardData.inadimplencia.valor_total).toLocaleString('pt-BR', {minimumFractionDigits: 2}) %></span>
          <span class="stat-desc">Valor total</span>
        </div>
        <div class="stat-item">
          <span class="stat-value danger"><%= dashboardData.inadimplencia.mais_30_dias %></span>
          <span class="stat-desc">+30 dias atraso</span>
        </div>
      </div>
    </div>
  </div>
</div>

<style>
.dashboard-container { max-width: 1400px; margin: 0 auto; padding: 20px; }
.kpi-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(280px, 1fr)); gap: 20px; margin-bottom: 30px; }
.kpi-card { background: white; border-radius: 12px; padding: 24px; box-shadow: 0 2px 8px rgba(0,0,0,0.1); display: flex; align-items: center; gap: 16px; }
.kpi-card.positive { border-left: 4px solid #10b981; }
.kpi-card.warning { border-left: 4px solid #f59e0b; }
.kpi-icon { font-size: 32px; }
.kpi-value { font-size: 28px; font-weight: 700; margin: 8px 0; }
.kpi-value.positive { color: #10b981; }
.kpi-value.negative { color: #ef4444; }
.kpi-change { font-size: 14px; }
.kpi-change.positive { color: #10b981; }
.kpi-change.negative { color: #ef4444; }
.kpi-previous { color: #6b7280; margin-left: 8px; }
.widgets-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(300px, 1fr)); gap: 20px; }
.widget-card { background: white; border-radius: 12px; padding: 20px; box-shadow: 0 2px 8px rgba(0,0,0,0.1); }
.alert-item, .ranking-item { padding: 8px 0; border-bottom: 1px solid #f3f4f6; }
.alert-item:last-child, .ranking-item:last-child { border-bottom: none; }
.rank { background: #3b82f6; color: white; padding: 2px 8px; border-radius: 12px; font-size: 12px; }
.stats-row { display: flex; justify-content: space-around; }
.stats-col { display: flex; flex-direction: column; gap: 12px; }
.stat { text-align: center; }
.stat-number { display: block; font-size: 24px; font-weight: 700; }
.stat-number.positive { color: #10b981; }
.stat-number.warning { color: #f59e0b; }
.stat-number.danger { color: #ef4444; }
.stat-label { font-size: 12px; color: #6b7280; }
.stat-value { font-size: 20px; font-weight: 600; }
.stat-desc { font-size: 12px; color: #6b7280; }
.text-success { color: #10b981; }
</style>

<%- include('partials/footer') %>