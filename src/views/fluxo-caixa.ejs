<%- include('partials/header', {
  titulo: 'Fluxo de Caixa',
  subtitulo: 'Acompanhe suas entradas e sa√≠das financeiras',
  user: locals.user
}) %>

<style>
  .btn-group {
    display: flex;
    gap: 5px;
  }
  
  .btn-warning {
    background-color: #ffc107;
    color: #212529;
    border: none;
    padding: 5px 10px;
    font-size: 12px;
    border-radius: 4px;
    cursor: pointer;
    transition: background-color 0.3s;
  }
  
  .btn-warning:hover {
    background-color: #e0a800;
  }
</style>

<div class="stats">
  <div class="stat-card">
    <h3>R$ <%= parseFloat(totais.total_credito || 0).toLocaleString('pt-BR', {minimumFractionDigits: 2}) %></h3>
    <p>Total de Entradas</p>
  </div>
  <div class="stat-card">
    <h3>R$ <%= parseFloat(totais.total_debito || 0).toLocaleString('pt-BR', {minimumFractionDigits: 2}) %></h3>
    <p>Total de Sa√≠das</p>
  </div>
  <div class="stat-card <%= saldoAtual >= 0 ? 'saldo-positivo-bg' : 'saldo-negativo-bg' %>">
    <h3>R$ <%= saldoAtual.toLocaleString('pt-BR', {minimumFractionDigits: 2}) %></h3>
    <p>Saldo Atual</p>
  </div>
</div>

<div class="card">
  <h2>‚ûï Novo Lan√ßamento Avulso</h2>
  <form action="/fluxo-caixa/lancamento" method="POST">
    <div class="form-row">
        <div class="form-group">
            <label for="data_operacao">Data *</label>
            <input type="date" id="data_operacao" name="data_operacao" value="<%= hoje %>" required>
        </div>
        <div class="form-group">
            <label for="tipo">Tipo *</label>
            <select id="tipo" name="tipo" required>
                <option value="CREDITO">Entrada (Cr√©dito)</option>
                <option value="DEBITO">Sa√≠da (D√©bito)</option>
            </select>
        </div>
    </div>
    <div class="form-row">
        <div class="form-group">
            <label for="valor">Valor (R$) *</label>
            <input type="number" id="valor" name="valor" step="0.01" min="0.01" required>
        </div>
        <div class="form-group">
            <label for="descricao">Descri√ß√£o *</label>
            <input type="text" id="descricao" name="descricao" required>
        </div>
    </div>
    <div class="form-group">
        <label for="categoria_id">Categoria *</label>
        <select id="categoria_id" name="categoria_id" required>
            <option value="" disabled selected>Selecione uma categoria</option>
            <% categorias.forEach(cat => { %>
                <option value="<%= cat.id %>"><%= cat.nome %></option>
            <% }) %>
        </select>
    </div>
    <button type="submit" class="btn">Registrar Lan√ßamento</button>
  </form>
</div>

<div class="card">
  <h2>üìã √öltimos Lan√ßamentos</h2>
  <table class="table">
    <thead>
      <tr>
        <th>Data</th>
        <th>Tipo</th>
        <th>Descri√ß√£o</th>
        <th>Categoria</th>
        <th class="text-right">Valor</th>
        <th>A√ß√µes</th>
      </tr>
    </thead>
    <tbody>
      <% if (lancamentos.length > 0) { %>
        <% lancamentos.forEach(item => { %>
          <tr>
            <td><%= new Date(item.data_operacao).toLocaleDateString('pt-BR', {timeZone: 'UTC'}) %></td>
            <td><span class="badge <%= item.tipo === 'CREDITO' ? 'badge-success' : 'badge-danger' %>"><%= item.tipo %></span></td>
            <td><%= item.descricao %></td>
            <td><%= item.categoria_nome || 'N√£o categorizado' %></td>
            <td class="text-right <%= item.tipo === 'CREDITO' ? 'saldo-positivo' : 'saldo-negativo' %>">
              <%= item.tipo === 'CREDITO' ? '+' : '-' %> R$ <%= parseFloat(item.valor).toLocaleString('pt-BR', {minimumFractionDigits: 2}) %>
            </td>
            <td>
              <div class="btn-group">
                <% if (item.conta_receber_id && item.tipo === 'CREDITO') { %>
                  <!-- Bot√£o de estornar para lan√ßamentos vindos de contas a receber -->
                  <form action="/fluxo-caixa/estornar/<%= item.id %>" method="POST" onsubmit="return confirm('Tem certeza que deseja estornar este recebimento? O lan√ßamento voltar√° para Contas a Receber.');">
                    <button type="submit" class="btn btn-warning" title="Estornar recebimento">
                      ‚Ü©Ô∏è Estornar
                    </button>
                  </form>
                <% } else if (item.conta_pagar_id && item.tipo === 'DEBITO') { %>
                  <!-- Bot√£o de estornar para lan√ßamentos vindos de contas a pagar -->
                  <form action="/fluxo-caixa/estornar/<%= item.id %>" method="POST" onsubmit="return confirm('Tem certeza que deseja estornar este pagamento? O lan√ßamento voltar√° para Contas a Pagar.');">
                    <button type="submit" class="btn btn-warning" title="Estornar pagamento">
                      ‚Ü©Ô∏è Estornar
                    </button>
                  </form>
                <% } %>
                
                <!-- Bot√£o de excluir -->
                <% if (!item.conta_receber_id && !item.conta_pagar_id) { %>
                  <!-- S√≥ mostra excluir para lan√ßamentos avulsos -->
                  <form action="/fluxo-caixa/delete/<%= item.id %>" method="POST" onsubmit="return confirm('Tem certeza que deseja excluir este lan√ßamento? Esta a√ß√£o √© irrevers√≠vel.');">
                    <button type="submit" class="btn btn-danger" style="padding: 5px 10px; font-size: 12px;">Excluir</button>
                  </form>
                <% } else { %>
                  <!-- Para lan√ßamentos de contas, mostra bot√£o desabilitado com tooltip -->
                  <button class="btn btn-danger" style="padding: 5px 10px; font-size: 12px; opacity: 0.5; cursor: not-allowed;" disabled title="Para excluir, use o bot√£o Estornar primeiro">
                    Excluir
                  </button>
                <% } %>
              </div>
            </td>
          </tr>
        <% }) %>
      <% } else { %>
        <tr>
          <td colspan="6" class="text-center">Nenhum lan√ßamento encontrado.</td>
        </tr>
      <% } %>
    </tbody>
  </table>
</div>

<%- include('partials/footer') %>