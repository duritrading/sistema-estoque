<%- include('partials/header', {
  titulo: 'Controle de InadimplÃªncia',
  subtitulo: 'GestÃ£o de contas a receber vencidas',
  user: locals.user
}) %>

<div class="card">
  <h2>ðŸš¨ RelatÃ³rio de InadimplÃªncia</h2>
  <p>Abaixo estÃ£o todas as parcelas com pagamento atrasado.</p>

  <div style="overflow-x: auto;">
    <table class="table mt-2">
      <thead>
        <tr>
          <th>Cliente</th>
          <th>Produto</th>
          <th>Vencimento</th>
          <th>Dias em Atraso</th> <!-- NOVA COLUNA -->
          <th>Parcela</th>
          <th class="text-right">Valor Atrasado</th>
          <th>AÃ§Ãµes</th>
        </tr>
      </thead>
      <tbody>
        <% if (contas.length === 0) { %>
          <tr>
            <td colspan="7" class="text-center">Nenhuma conta em atraso encontrada.</td>
          </tr>
        <% } else { %>
          <% 
            const hoje = new Date();
            hoje.setHours(0, 0, 0, 0);
            
            contas.forEach(conta => { 
              const vencimento = new Date(conta.data_vencimento);
              vencimento.setHours(0, 0, 0, 0);
              const diasAtraso = Math.floor((hoje - vencimento) / (1000 * 60 * 60 * 24));
          %>
            <tr>
              <td><%= conta.cliente_nome %></td>
              <td><%= conta.produto_descricao || 'LanÃ§amento Manual' %></td>
              <td><%= new Date(conta.data_vencimento).toLocaleDateString('pt-BR', { timeZone: 'UTC' }) %></td>
              <td>
                <span class="badge <%= diasAtraso > 30 ? 'badge-danger' : 'badge-warning' %>">
                  <%= diasAtraso %> <%= diasAtraso === 1 ? 'dia' : 'dias' %>
                </span>
              </td> <!-- NOVA COLUNA COM DIAS -->
              <td><%= conta.numero_parcela %> / <%= conta.total_parcelas %></td>
              <td class="text-right saldo-negativo">R$ <%= parseFloat(conta.valor).toLocaleString('pt-BR', { minimumFractionDigits: 2 }) %></td>
              <td>
  <div style="display: flex; gap: 5px; justify-content: flex-end;">
    <form action="/contas-a-receber/registrar-pagamento/<%= conta.id %>" method="POST" onsubmit="return confirm('Confirma o recebimento desta parcela em atraso?');">
      <button type="submit" class="btn btn-success" style="padding: 5px 10px; font-size: 12px;">Receber</button>
    </form>
    
    <% if (!conta.movimentacao_id) { %>
      <form action="/contas-a-receber/delete/<%= conta.id %>" method="POST" onsubmit="return confirm('Tem certeza que deseja excluir este lanÃ§amento manual?');">
          <button type="submit" class="btn btn-danger" style="padding: 5px 10px; font-size: 12px;">Excluir</button>
      </form>
    <% } %>
  </div>
</td>
      </tbody>
      <tfoot>
        <tr style="font-weight: bold; background-color: #f8f9fa;">
            <td colspan="5" class="text-right">Total em Atraso:</td>
            <td class="text-right saldo-negativo">R$ <%= totalInadimplencia.toLocaleString('pt-BR', {minimumFractionDigits: 2}) %></td>
            <td></td>
        </tr>
      </tfoot>
    </table>
  </div>
</div>

<%- include('partials/footer') %>