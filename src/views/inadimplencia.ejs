<%- include('partials/header', {
  titulo: 'Inadimpl√™ncia',
  subtitulo: 'An√°lise de contas vencidas e n√£o pagas',
  user: locals.user
}) %>

<div class="stats-grid">
  <div class="stat-card danger">
    <h3>Total em Atraso</h3>
    <p class="stat-value text-danger">R$ <%= totalEmAtraso.toLocaleString('pt-BR', {minimumFractionDigits: 2}) %></p>
    <p class="stat-label">Vencidas e n√£o pagas</p>
  </div>
  
  <div class="stat-card warning">
    <h3>Contas Vencidas</h3>
    <p class="stat-value text-warning"><%= contasVencidas.length %></p>
    <p class="stat-label">Parcelas em atraso</p>
  </div>
  
  <div class="stat-card info">
    <h3>Clientes Inadimplentes</h3>
    <p class="stat-value text-info"><%= clientesInadimplentes %></p>
    <p class="stat-label">Com parcelas vencidas</p>
  </div>
</div>

<div class="card">
  <h2>üìä Parcelas Vencidas e N√£o Pagas</h2>
  
  <% if (contasVencidas.length > 0) { %>
    <div class="table-responsive">
      <table class="table inadimplencia-table">
        <thead>
          <tr>
            <th>Cliente</th>
            <th>Produto</th>
            <th>Parcela</th>
            <th>Valor</th>
            <th>Vencimento</th>
            <th>Dias em Atraso</th>
            <th>A√ß√µes</th>
          </tr>
        </thead>
        <tbody>
          <% contasVencidas.forEach(conta => { %>
            <tr>
              <td><strong><%= conta.cliente_nome %></strong></td>
              <td><%= conta.produto_descricao || '-' %></td>
              <td style="white-space: nowrap;"><%= conta.numero_parcela %>/<%= conta.total_parcelas %></td>
              <td style="white-space: nowrap;">R$ <%= parseFloat(conta.valor).toLocaleString('pt-BR', {minimumFractionDigits: 2}) %></td>
              <td style="white-space: nowrap;"><%= new Date(conta.data_vencimento).toLocaleDateString('pt-BR', {timeZone: 'UTC'}) %></td>
              <td class="text-center">
                <span class="badge badge-danger" style="font-size: 14px; padding: 6px 12px;">
                  <%= Math.floor(conta.dias_atraso) %> dias
                </span>
              </td>
              <td>
                <div style="display: flex; gap: 8px; justify-content: flex-start; flex-wrap: wrap;">
                  
                  <!-- Bot√£o Marcar como Paga com Modal -->
                  <button type="button" class="btn btn-sm btn-success" 
                          onclick="abrirModalPagamento('<%= conta.id %>', '<%= conta.cliente_nome %>', '<%= conta.valor %>', '<%= conta.numero_parcela %>', '<%= conta.total_parcelas %>')"
                          title="Marcar como paga">
                    <span style="white-space: nowrap;">‚úì Marcar como Paga</span>
                  </button>

                  <!-- Bot√£o Excluir -->
                  <form action="/inadimplencia/excluir/<%= conta.id %>" method="POST" style="display: inline;" 
                        onsubmit="return confirm('‚ö†Ô∏è ATEN√á√ÉO: Excluir esta conta ir√°:\n\n‚Ä¢ Remover permanentemente do sistema\n‚Ä¢ N√£o poder√° ser recuperada\n\nAPENAS para contas lan√ßadas por engano!\n\nDeseja continuar?');">
                    <button type="submit" class="btn btn-sm btn-danger" title="Excluir conta (apenas contas manuais)">
                      <span style="white-space: nowrap;">üóëÔ∏è Excluir</span>
                    </button>
                  </form>
                  
                </div>
              </td>
            </tr>
          <% }) %>
        </tbody>
      </table>
    </div>
  <% } else { %>
    <div class="alert alert-success">
      <p style="margin: 0; text-align: center;">‚úÖ N√£o h√° parcelas vencidas no momento!</p>
    </div>
  <% } %>
</div>

<!-- Modal para sele√ß√£o de data de pagamento -->
<div id="modalPagamento" class="modal-overlay-pagamento">
  <div class="modal-content-pagamento">
    <div class="modal-header-pagamento">
      <h3>üí∞ Registrar Pagamento</h3>
      <button type="button" class="btn-close-modal" onclick="fecharModalPagamento()">√ó</button>
    </div>
    
    <form id="formPagamento" method="POST">
      <div class="modal-body-pagamento">
        <div class="info-row">
          <label>Cliente:</label>
          <div class="info-value" id="clienteNome"></div>
        </div>
        
        <div class="info-row">
          <label>Parcela:</label>
          <div class="info-value" id="parcelaInfo"></div>
        </div>
        
        <div class="info-row">
          <label>Valor:</label>
          <div class="info-value valor-destaque" id="valorConta"></div>
        </div>
        
        <div class="form-group-modal">
          <label for="dataPagamento">Data do Pagamento: <span class="required">*</span></label>
          <input type="date" id="dataPagamento" name="data_pagamento" required class="input-date">
        </div>
      </div>
      
      <div class="modal-footer-pagamento">
        <button type="button" onclick="fecharModalPagamento()" class="btn-modal-cancel">
          Cancelar
        </button>
        <button type="submit" class="btn-modal-confirm">
          ‚úì Confirmar Pagamento
        </button>
      </div>
    </form>
  </div>
</div>

<!-- CSS COMPLETO E CORRIGIDO PARA O MODAL -->
<style>
/* ====== ESTILOS B√ÅSICOS DA P√ÅGINA ====== */
.stats-grid {
  display: grid;
  grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
  gap: 25px;
  margin-bottom: 35px;
}

.stat-card {
  background: white;
  padding: 25px;
  border-radius: 12px;
  box-shadow: 0 2px 10px rgba(0,0,0,0.1);
  border: 2px solid transparent;
  transition: all 0.3s ease;
}

.stat-card.danger { border-color: #dc3545; }
.stat-card.warning { border-color: #ffc107; }
.stat-card.info { border-color: #17a2b8; }

.stat-value {
  font-size: 32px;
  font-weight: bold;
  margin: 15px 0 5px 0;
}

.text-danger { color: #dc3545; }
.text-warning { color: #ffc107; }
.text-info { color: #17a2b8; }

.stat-label {
  color: #666;
  font-size: 14px;
  margin: 0;
}

.table-responsive {
  overflow-x: auto;
  margin-top: 20px;
}

.inadimplencia-table {
  width: 100%;
  border-collapse: collapse;
  margin-top: 15px;
}

.inadimplencia-table th,
.inadimplencia-table td {
  padding: 12px;
  text-align: left;
  border-bottom: 1px solid #ddd;
}

.inadimplencia-table th {
  background-color: #f8f9fa;
  font-weight: 600;
  color: #333;
}

.btn {
  padding: 8px 16px;
  border: none;
  border-radius: 6px;
  cursor: pointer;
  font-size: 14px;
  font-weight: 500;
  text-decoration: none;
  display: inline-block;
  transition: all 0.2s;
}

.btn-sm {
  padding: 6px 12px;
  font-size: 12px;
}

.btn-success {
  background-color: #28a745;
  color: white;
}

.btn-success:hover {
  background-color: #218838;
  transform: translateY(-1px);
}

.btn-danger {
  background-color: #dc3545;
  color: white;
}

.btn-danger:hover {
  background-color: #c82333;
  transform: translateY(-1px);
}

.badge-danger {
  background-color: #dc3545;
  color: white;
  padding: 6px 12px;
  border-radius: 6px;
  font-size: 12px;
  font-weight: 600;
}

.text-center {
  text-align: center;
}

.alert-success {
  background: #d4edda;
  color: #155724;
  border: 1px solid #c3e6cb;
  padding: 20px;
  border-radius: 8px;
  margin-top: 20px;
}

/* ====== MODAL ESTILOS COMPLETOS E CORRIGIDOS ====== */
.modal-overlay-pagamento {
  position: fixed !important;
  top: 0 !important;
  left: 0 !important;
  width: 100vw !important;
  height: 100vh !important;
  background: rgba(0, 0, 0, 0.7) !important;
  z-index: 99999 !important;
  display: none !important;
  align-items: center !important;
  justify-content: center !important;
  backdrop-filter: blur(4px) !important;
}

.modal-overlay-pagamento.show {
  display: flex !important;
}

.modal-content-pagamento {
  background: white !important;
  border-radius: 16px !important;
  width: 90% !important;
  max-width: 500px !important;
  max-height: 90vh !important;
  overflow-y: auto !important;
  box-shadow: 0 20px 40px rgba(0, 0, 0, 0.3) !important;
  animation: modalSlideIn 0.3s ease-out !important;
  position: relative !important;
}

.modal-header-pagamento {
  display: flex !important;
  justify-content: space-between !important;
  align-items: center !important;
  padding: 24px !important;
  border-bottom: 1px solid #e2e8f0 !important;
  background: #f8fafc !important;
  border-radius: 16px 16px 0 0 !important;
}

.modal-header-pagamento h3 {
  margin: 0 !important;
  color: #2d5a8e !important;
  font-size: 18px !important;
  font-weight: 600 !important;
}

.btn-close-modal {
  width: 35px !important;
  height: 35px !important;
  border: none !important;
  background: #e2e8f0 !important;
  border-radius: 50% !important;
  color: #64748b !important;
  cursor: pointer !important;
  font-size: 20px !important;
  display: flex !important;
  align-items: center !important;
  justify-content: center !important;
  transition: all 0.2s !important;
}

.btn-close-modal:hover {
  background: #cbd5e1 !important;
  color: #475569 !important;
}

.modal-body-pagamento {
  padding: 24px !important;
}

.info-row {
  margin-bottom: 16px !important;
  display: flex !important;
  justify-content: space-between !important;
  align-items: center !important;
  padding: 12px 0 !important;
  border-bottom: 1px solid #f1f5f9 !important;
}

.info-row label {
  font-weight: 600 !important;
  color: #374151 !important;
  font-size: 14px !important;
  margin: 0 !important;
}

.info-value {
  color: #111827 !important;
  font-weight: 500 !important;
  font-size: 16px !important;
}

.valor-destaque {
  color: #059669 !important;
  font-size: 20px !important;
  font-weight: 700 !important;
}

.form-group-modal {
  margin-top: 24px !important;
}

.form-group-modal label {
  display: block !important;
  margin-bottom: 8px !important;
  font-weight: 600 !important;
  color: #374151 !important;
  font-size: 14px !important;
}

.required {
  color: #dc2626 !important;
}

.input-date {
  width: 100% !important;
  padding: 12px !important;
  border: 2px solid #d1d5db !important;
  border-radius: 8px !important;
  font-size: 14px !important;
  transition: border-color 0.3s !important;
  box-sizing: border-box !important;
}

.input-date:focus {
  outline: none !important;
  border-color: #059669 !important;
  box-shadow: 0 0 0 3px rgba(5, 150, 105, 0.1) !important;
}

.modal-footer-pagamento {
  display: flex !important;
  gap: 12px !important;
  justify-content: flex-end !important;
  padding: 20px 24px !important;
  border-top: 1px solid #e2e8f0 !important;
  background: #f8fafc !important;
  border-radius: 0 0 16px 16px !important;
}

.btn-modal-cancel {
  padding: 12px 24px !important;
  border: 1px solid #d1d5db !important;
  background: white !important;
  color: #6b7280 !important;
  border-radius: 8px !important;
  cursor: pointer !important;
  font-size: 14px !important;
  font-weight: 600 !important;
  transition: all 0.2s !important;
}

.btn-modal-cancel:hover {
  background: #f9fafb !important;
  border-color: #9ca3af !important;
  color: #374151 !important;
}

.btn-modal-confirm {
  padding: 12px 24px !important;
  background: linear-gradient(135deg, #059669, #047857) !important;
  color: white !important;
  border: none !important;
  border-radius: 8px !important;
  cursor: pointer !important;
  font-size: 14px !important;
  font-weight: 600 !important;
  transition: all 0.2s !important;
  box-shadow: 0 4px 12px rgba(5, 150, 105, 0.3) !important;
}

.btn-modal-confirm:hover {
  background: linear-gradient(135deg, #047857, #065f46) !important;
  transform: translateY(-1px) !important;
  box-shadow: 0 6px 16px rgba(5, 150, 105, 0.4) !important;
}

@keyframes modalSlideIn {
  from {
    opacity: 0 !important;
    transform: scale(0.9) translateY(-30px) !important;
  }
  to {
    opacity: 1 !important;
    transform: scale(1) translateY(0) !important;
  }
}

/* Responsividade */
@media (max-width: 768px) {
  .stats-grid {
    grid-template-columns: 1fr;
    gap: 15px;
  }
  
  .stat-value {
    font-size: 24px;
  }
  
  .inadimplencia-table {
    font-size: 12px;
  }
  
  .inadimplencia-table th,
  .inadimplencia-table td {
    padding: 8px;
  }

  .modal-content-pagamento {
    width: 95% !important;
    margin: 10px !important;
  }

  .modal-footer-pagamento {
    flex-direction: column !important;
  }

  .btn-modal-cancel,
  .btn-modal-confirm {
    width: 100% !important;
  }
}
</style>

<!-- JAVASCRIPT CORRIGIDO E OTIMIZADO -->
<script>
console.log('üîß Script de inadimpl√™ncia carregado');

function abrirModalPagamento(contaId, clienteNome, valor, numeroParcela, totalParcelas) {
  console.log('üéØ Abrindo modal para conta:', contaId);
  
  try {
    // Verificar se elementos existem
    const modalEl = document.getElementById('modalPagamento');
    const formEl = document.getElementById('formPagamento');
    const clienteEl = document.getElementById('clienteNome');
    const parcelaEl = document.getElementById('parcelaInfo');
    const valorEl = document.getElementById('valorConta');
    const dataEl = document.getElementById('dataPagamento');

    if (!modalEl || !formEl || !clienteEl || !parcelaEl || !valorEl || !dataEl) {
      console.error('‚ùå Elementos do modal n√£o encontrados!');
      alert('Erro interno: Elementos do modal n√£o encontrados. Recarregue a p√°gina.');
      return;
    }

    // Preencher dados do modal
    clienteEl.textContent = clienteNome;
    parcelaEl.textContent = `${numeroParcela}/${totalParcelas}`;
    valorEl.textContent = 'R$ ' + parseFloat(valor).toLocaleString('pt-BR', {minimumFractionDigits: 2});
    
    // Definir a√ß√£o do formul√°rio
    formEl.action = '/inadimplencia/marcar-paga/' + contaId;
    
    // Definir data padr√£o como hoje
    const hoje = new Date().toISOString().split('T')[0];
    dataEl.value = hoje;
    
    // Mostrar modal
    modalEl.classList.add('show');
    modalEl.style.display = 'flex';
    
    console.log('‚úÖ Modal aberto com sucesso');
    
    // Focar no campo de data ap√≥s abertura
    setTimeout(() => {
      dataEl.focus();
    }, 300);
    
  } catch (error) {
    console.error('‚ùå Erro ao abrir modal:', error);
    alert('Erro ao abrir modal de pagamento. Recarregue a p√°gina e tente novamente.');
  }
}

function fecharModalPagamento() {
  console.log('üîí Fechando modal de pagamento');
  
  const modalEl = document.getElementById('modalPagamento');
  if (modalEl) {
    modalEl.classList.remove('show');
    modalEl.style.display = 'none';
  }
}

// Aguardar carregamento completo da p√°gina
document.addEventListener('DOMContentLoaded', function() {
  console.log('üìÑ DOM carregado, configurando eventos...');
  
  const modalEl = document.getElementById('modalPagamento');
  const formEl = document.getElementById('formPagamento');
  
  if (!modalEl || !formEl) {
    console.error('‚ùå Elementos cr√≠ticos n√£o encontrados!');
    return;
  }

  // Fechar modal clicando fora do conte√∫do
  modalEl.addEventListener('click', function(e) {
    if (e.target === modalEl) {
      fecharModalPagamento();
    }
  });

  // Fechar modal com ESC
  document.addEventListener('keydown', function(e) {
    if (e.key === 'Escape') {
      fecharModalPagamento();
    }
  });

  // Valida√ß√£o do formul√°rio
  formEl.addEventListener('submit', function(e) {
    const dataPagamento = document.getElementById('dataPagamento').value;
    
    if (!dataPagamento) {
      e.preventDefault();
      alert('Por favor, selecione a data do pagamento.');
      return;
    }
    
    // Verificar se a data n√£o √© muito futura (m√°ximo hoje)
    const hoje = new Date().toISOString().split('T')[0];
    if (dataPagamento > hoje) {
      e.preventDefault();
      alert('A data de pagamento n√£o pode ser no futuro.');
      return;
    }
    
    // Confirmar a√ß√£o
    const confirmacao = confirm('Confirma o recebimento desta parcela na data selecionada?');
    if (!confirmacao) {
      e.preventDefault();
      return;
    }
    
    console.log('‚úÖ Formul√°rio validado e enviado');
  });

  console.log('‚úÖ Eventos configurados com sucesso');
});
</script>

<%- include('partials/footer') %>